// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums removed for SQLite compatibility


// Models

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          String    @default("ORGANIZER") // ORGANIZER, VENDOR, ADMIN
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  vendorProfile VendorProfile?
  events        Event[]
  bookings      Booking[]      @relation("OrganizerBookings") // Bookings made by this user (if organizer)
  reviews       Review[]       @relation("WrittenReviews")
  sentMessages     Message[]   @relation("SentMessages")
  receivedMessages Message[]   @relation("ReceivedMessages")
}

model VendorProfile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessName  String
  description   String?
  category      String
  location      String
  occasions     String?   // Comma separated list of occasions (e.g., "Weddings, Birthdays")
  phoneNumber   String?
  website       String?
  imageUrl      String?
  rating        Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  services      Service[]
  bookings      Booking[] // Bookings received by this vendor
  quotes        Quote[]
  availability  Availability[]
  reviews       Review[]  @relation("VendorReviews")
}

model Service {
  id            String    @id @default(cuid())
  vendorId      String
  vendor        VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  basePrice     Float
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  packages      Package[]
  bookings      Booking[]
}

model Package {
  id            String    @id @default(cuid())
  serviceId     String
  service       Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  price         Float
  features      String?   // Comma separated list or JSON string
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  bookings      Booking[]
}

model Event {
  id            String    @id @default(cuid())
  organizerId   String
  organizer     User      @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  title         String
  date          DateTime
  location      String
  type          String
  budget        Float
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  bookings      Booking[]
}

model Booking {
  id            String        @id @default(cuid())
  eventId       String
  event         Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  vendorId      String
  vendor        VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  organizerId   String
  organizer     User          @relation("OrganizerBookings", fields: [organizerId], references: [id])
  packageId     String?
  package       Package?      @relation(fields: [packageId], references: [id])
  serviceId     String?
  service       Service?      @relation(fields: [serviceId], references: [id])
  
  status        String        @default("PENDING") // PENDING, QUOTED, ACCEPTED, REJECTED, CONFIRMED, COMPLETED, CANCELLED
  date          DateTime
  price         Float         // Final agreed price
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relationships
  quotes        Quote[]
  payments      Payment[]
  review        Review?
  messages      Message[]
}

model Quote {
  id            String      @id @default(cuid())
  bookingId     String
  booking       Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vendorId      String
  vendor        VendorProfile @relation(fields: [vendorId], references: [id])
  amount        Float
  details       String?
  validUntil    DateTime?
  status        String      @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Payment {
  id            String        @id @default(cuid())
  bookingId     String
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount        Float
  status        String        @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED
  method        String        // e.g., "card", "bank_transfer"
  transactionId String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Review {
  id            String        @id @default(cuid())
  bookingId     String        @unique
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vendorId      String
  vendor        VendorProfile @relation("VendorReviews", fields: [vendorId], references: [id])
  authorId      String
  author        User          @relation("WrittenReviews", fields: [authorId], references: [id])
  rating        Int
  comment       String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Message {
  id            String    @id @default(cuid())
  bookingId     String?
  booking       Booking?  @relation(fields: [bookingId], references: [id])
  senderId      String
  sender        User      @relation("SentMessages", fields: [senderId], references: [id])
  receiverId    String
  receiver      User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content       String
  createdAt     DateTime  @default(now())
}

model Availability {
  id            String             @id @default(cuid())
  vendorId      String
  vendor        VendorProfile      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  date          DateTime
  status        String             @default("AVAILABLE") // AVAILABLE, BOOKED, UNAVAILABLE
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@unique([vendorId, date])
}
